#!/bin/bash

########################################################################TODO:#############################################################################
## Ubuntu 18.04.6 LTS (Bionic Beaver) >> nodeJS 18 ^ ì‚¬ìš© ë¶ˆê°€ >> ì´ ê²½ìš° node_versionì„ 14.21.3
## OS ë²„ì „ ì²´í¬í•´ì„œ node_version ë°”ê¾¸ëŠ” í˜•ì‹ìœ¼ë¡œ ê°œì„ í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¤.
##########################################################################################################################################################

########################################################################TEST##############################################################################
## í…ŒìŠ¤íŠ¸ í™˜ê²½

## Ubuntu 18.04.6 LTS (Bionic Beaver) >> node_versionì„ 14.21.3 ê³ ì³ì„œ ì‚¬ìš©í•´ì•¼ í•¨
## Ubuntu 20.04.6 LTS (Focal Fossa) WSL >> nodeJS 18 (O)

## Rocky Linux 8.8 (Green Obsidian) >> nodeJS 18 (O)
##########################################################################################################################################################

##########################################################################################################################################################
# nvm ê²½ë¡œ
nvm_dir="$HOME/.nvm"

## nodeJS version ##
# # nodeJS version - Ubuntu 18.04.6 LTS
# node_version="14.21.3"
# nodeJS version
node_version="18.16.1"
##

# /node_modules
node_modules="node_modules"

#
# CLI
cli="[ ğŸ™SSOOğŸ™ ]"
# COLOR
red="\e[31m"
green="\e[32m"
yellow="\e[33m"
reset="\e[0m"
revert="\e[7m"
new_line="\n"
# ì¢…ë£Œ ë©˜íŠ¸
exit_word="$revert==================================ì¢…ë£Œ==================================$reset$new_line"
# ë¼ì¸
bar="â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– $new_line"
##########################################################################################################################################################

##########################################################################################################################################################
# pm2 ì„¤ì¹˜
install_pm2() {
    local is_pm2=$(command -v pm2)

    if [ -z $is_pm2 ]
    then
        npm install pm2 -g

        pm2 install pm2-logrotate

        pm2 set pm2-logrotate:retain 10
    fi

}
##########################################################################################################################################################

##########################################################################################################################################################
# nvm ì„¤ì¹˜
install_nvm() {
    # nvm ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
    if [ ! -d "$nvm_dir" ]
    then
        echo "$cli nvmì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì œê°€ ì„¤ì¹˜í•´ë“œë¦´ê²Œìš”!"
        # ë‹¤ìš´ ë°›ê³ 
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
        
        # ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë°˜ì˜í•´ì£¼ê¸°
        source ~/.bashrc

        echo -e $bar
    fi
    
    # nodeJS ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸ > ì„¤ì¹˜
    install_nodeJS
}
##########################################################################################################################################################

##########################################################################################################################################################
# nodeJS ì„¤ì¹˜
install_nodeJS() {

    # nvm ë¡œë“œí•˜ê³ ...
    [ -s "$nvm_dir/nvm.sh" ] && \. "$nvm_dir/nvm.sh" --silent

    
    # Node.js ë²„ì „ í™•ì¸
    local current_node=$(nvm current)
    echo -e "$cli í˜„ì¬ nodeJS ë²„ì „: $yellow$current_node$reset"

    if [ $current_node = "none" ]
    then
        # ì§€ì •ëœ nodeJS versionìœ¼ë¡œ ì„¤ì¹˜ > ì²« ì„¤ì¹˜ë¼ì„œ default alias ìë™
        nvm install $node_version
    elif [ "$current_node" != "v$node_version" ]
    then 
        # ì„¤ì¹˜ê°€ ë˜ì–´ìˆë‹¤ë©´, í˜„ì¬ default versionì´ ì§€ì •ëœ versionì¸ì§€ í™•ì¸
        nvm install $node_version
        # default alias ë³€ê²½
        nvm alias default $node_version
    else
        echo -e "$cli ìš”êµ¬ë˜ëŠ” nodeJS ë²„ì „ì„ ê°–ì¶”ì—ˆêµ°ìš”!$new_line"
    fi

    echo -e $bar

    # pm2 ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸ > ì„¤ì¹˜
    install_pm2
}
##########################################################################################################################################################

# ì‹¤í–‰í•˜ë©´ ì‹¤í–‰ë˜ëŠ” êµ¬ê°„ #
##########################################################################################################################################################
echo -e "$new_line$revert==================================ì‹œì‘==================================$reset$new_line"

# í˜„ì¬ user
user=$(whoami)
echo -e "$cli ì•ˆë…•í•˜ì„¸ìš”, $green$user$reset! $new_line"
echo -e $bar

check_node=$(command -v node)

if [ -z $check_node ]
then
    install_nvm
else
    current_node=$(node -v)
    if [ $current_node != $node_version ]
    then 
        install_nvm
    fi
fi

echo -e $exit_word